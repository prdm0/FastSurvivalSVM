---
title: "Using Custom Kernels with FastSurvivalSVM: The Wavelet Kernel"
author: "Pedro Rafael Diniz Marinho"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Using Custom Kernels with FastSurvivalSVM: The Wavelet Kernel}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment  = "#>"
)
```

## Introduction

The FastSurvivalSVM package provides an efficient R interface to the Python class
FastKernelSurvivalSVM from the scikit-survival library.

A powerful feature of this package is the ability to define fully custom kernel
functions in R. Previously, this required complex programming patterns (function
factories and closures). Now, with the helper function `grid_kernel()`, defining
and using a custom kernel is straightforward.

This vignette demonstrates:

- How to define a custom kernel using simple R syntax.
- How to instantiate a specific kernel version using `grid_kernel()`.
- How to fit a model using the wavelet kernel (Ará et al., 2016).
- How to extract predictions, C-index, coefficients, and hyperparameters.

## Data Example

We begin by generating a synthetic survival dataset with nonlinear relationships
to test the kernel's capability.

```{r}
library(FastSurvivalSVM)

# Function to generate synthetic survival data
data_generation <- function(n, prop_cen) {
    x1 <- rnorm(n, 1, 1)
    x2 <- rnorm(n, 2, 2)
    x3 <- rexp(n)
    
    xbeta <- x1 * log(abs(x2)) + 2 * sin(x3 - x2)^2
    shape <- 2
    scale <- 5
    
    u <- runif(n, 0, 1)
    time_t <- ((-log(1 - u))^(1 / shape)) * scale * exp(-xbeta)
    
    ind_cens <- sample(1:n, n * prop_cen, replace = FALSE)
    time_gerado <- time_t
    time_gerado[ind_cens] <- runif(
        length(ind_cens),
        min(time_t),
        time_t[ind_cens]
    )
    
    cens <- rep(1, n)
    cens[ind_cens] <- 0

    data.frame(
        tempo = time_gerado,
        cens  = cens,
        x1    = x1,
        x2    = x2,
        x3    = x3
    )
}

set.seed(123)
df <- data_generation(n = 300L, prop_cen = 0.1)

head(df)
```

## Wavelet Kernel Implementation

The wavelet kernel described in Ará et al. (2016) uses the following mother
function:

$$
h(u) = \cos(1.75u) e^{-u^2 / 2}
$$

And the kernel is defined as the product over covariates:

$$
K(x, z) = \prod_{k=1}^p h\left( \frac{x_k - z_k}{A} \right)
$$

### 1. Defining the Kernel Function

```{r}
wavelet_kernel_fn <- function(x, z, A = 1) {
  x <- as.numeric(x)
  z <- as.numeric(z)
  u <- (x - z) / A
  prod(cos(1.75 * u) * exp(-0.5 * u^2))
}
```

### 2. Instantiating the Kernel

```{r}
my_wavelet <- grid_kernel(wavelet_kernel_fn, A = 0.5)
class(my_wavelet)
```

## Fitting the Model

```{r}
fit_wavelet <- fastsvm(
  data          = df,
  time_col      = "tempo",
  delta_col     = "cens",
  kernel        = my_wavelet,
  alpha         = 1,
  rank_ratio    = 0,
  fit_intercept = FALSE
)
```

## Predictions

```{r}
preds <- predict(fit_wavelet, df)
head(preds)
```

## Concordance Index (C-index)

```{r}
c_index <- score(fit_wavelet, df)
cat(sprintf("C-index on training data: %.4f\n", c_index))
```

## Model Summary

```{r}
summary(fit_wavelet)
```

## Extracting Coefficients and Parameters

```{r}
head(coef(fit_wavelet))
get_params_fastsvm(fit_wavelet)
```

## Conclusion

This vignette demonstrated the streamlined workflow for custom kernels in
FastSurvivalSVM.

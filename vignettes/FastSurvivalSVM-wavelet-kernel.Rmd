---
title: "Using Custom Kernels with FastSurvivalSVM: The Wavelet Kernel"
author: "Pedro Rafael Diniz Marinho"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Using Custom Kernels with FastSurvivalSVM: The Wavelet Kernel}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment  = "#>"
)
```

# Introduction

The **FastSurvivalSVM** package provides an R interface to the Python class  
[`FastKernelSurvivalSVM`](https://scikit-survival.readthedocs.io/en/stable/api/generated/sksurv.svm.FastKernelSurvivalSVM.html),  
implemented in the *scikit-survival* library.

In addition to supporting built-in kernels such as `"rbf"`, `"poly"`, and `"sigmoid"`,  
the package allows R users to define **fully custom kernel functions**.

This vignette demonstrates:

- How to construct custom kernels in R  
- How to use them within `fast_kernel_surv_svm_fit()`  
- How to fit models using the **wavelet kernel** from the article *SVM Wavelet (Ar치 et al., 2016)*  
- How to extract predictions, C-index, coefficients, and hyperparameters  

---

# Data Example

```{r}
# remotes::install_github("prdm0/FastSurvivalSVM", force = T)

library(FastSurvivalSVM)

data_generation <- function(n, prop_cen) {
    # 3 covariaveis
    x1 <- rnorm(n, 1, 1)
    x2 <- rnorm(n, 2, 2)
    x3 <- rexp(n)
    # par칙metros da Weibull
    xbeta <- x1 * log(abs(x2)) + 2 * sin(x3 - x2)^2
    shape <- 2
    scale <- 5
    # tempos verdadeiros (sem censura)
    u <- runif(n, 0, 1)
    time_t <- ((-log(1 - u))^(1 / shape)) * scale * exp(-xbeta)
    # selecionar quem ser치 censurado e gerar os tempos
    ind_cens <- sample(1:n, n * prop_cen, replace = FALSE)
    time_gerado <- time_t
    time_gerado[ind_cens] <- runif(
        length(ind_cens),
        min(time_t),
        time_t[ind_cens]
    )
    # criando a indicadora de falha
    cens <- rep(1, n)
    cens[ind_cens] <- 0

    dados_g <- data.frame(
        tempo = time_gerado,
        cens = cens,
        x1 = x1,
        x2 = x2,
        x3 = x3
    )
    return(dados_g)
}

set.seed(123)

df <- data_generation(n = 300L, prop_cen = 0.1)

head(df)
```

---

# Wavelet Kernel from the Literature

The wavelet kernel used in Ar치 et al. (2016) is based on the wavelet mother function:

\[
h(u) = \cos(1.75\,u)\,e^{-u^2/2}.
\]

The kernel is:

\[
K(x,z) = \prod_{k=1}^p h\!\left(\frac{x_k - z_k}{A}\right).
\]

---

## Wavelet mother function

```{r}
wavelet_mother <- function(u) {
  cos(1.75 * u) * exp(-0.5 * u^2)
}
```

## Wavelet kernel

```{r}
wavelet_kernel <- function(x, z, A = 1) {
  x <- as.numeric(x)
  z <- as.numeric(z)
  stopifnot(length(x) == length(z))

  u <- (x - z) / A
  prod(wavelet_mother(u))
}
```

## Kernel factory

```{r}
make_wavelet_kernel <- function(A = 1) {
  force(A)
  function(x, z) wavelet_kernel(x, z, A = A)
}
```

---

# Fitting the model

```{r}
fit_wavelet <- fastsvm(
  data       = df,
  time_col   = "tempo",
  delta_col  = "cens",
  kernel     = make_wavelet_kernel(A = 0.5),
  alpha      = 1,
  rank_ratio = 0,
  fit_intercept = FALSE
)
```

---

# Predictions

```{r}
preds <- predict(fit_wavelet, df)
head(preds)
```

---

# Concordance Index

```{r}
score(fit_wavelet, df)
```

---

# Summary

```{r}
summary(fit_wavelet)
```

---

# Extracting coefficients and parameters

```{r}
coef(fit_wavelet)
get_params_fastsvm(fit_wavelet)
```

---

# Conclusion

This vignette demonstrated how to:

- Implement custom kernels in R  
- Use the wavelet kernel with FastSurvivalSVM  
- Fit, predict, compute the C-index  
- Extract coefficients and hyperparameters  

The package enables flexible experimentation with kernel survival SVMs directly from R.
